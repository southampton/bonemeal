#!/bin/bash
INSTALL_HOST="install.soton.ac.uk"
BUILD_MOUNT="/mnt/build"

if [ -f /.bonemeal ]; then

	## prevent logs from being printed on tty1
	/bin/dmesg -n1

	echo "[bonemeal] Waiting for network..."

	# Attempt this up to 60 times (approximately 60-120 seconds)
	for i in {1..60}; do
		# Ping once, waiting up to one second
		ping -q -c 1 -W 1 $INSTALL_HOST >/dev/null 2>/dev/null

		# If the ping succeeded...
		if [ "x$?" == "x0" ]; then
			# Stop waiting
			break
		fi

		# If the network is down, pinging will fail almost immediately, so sleep
		sleep 1
	done

	# Even if the above fails, try to update the installer anyway
	echo "[bonemeal] Updating installer from $INSTALL_HOST..."
	mkdir -p $BUILD_MOUNT
	mount -o nolock $INSTALL_HOST:/data/bonemeal $BUILD_MOUNT
	cp $BUILD_MOUNT/bonemeal.server /sbin/soton-setup-run
	umount $BUILD_MOUNT
	chmod 0755 /sbin/soton-setup-run

	/sbin/soton-setup-run
fi
